<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Retro Dialog Editor</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #1a1a2e;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        h1 { color: #88f; text-align: center; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 20px; }

        .container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .preview-area {
            flex: 1;
            background: #2a2a4e;
            border-radius: 8px;
            padding: 20px;
        }

        .style-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .style-nav button {
            background: #335;
            color: #fff;
            border: 2px solid #446;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        .style-nav button:hover { background: #446; }
        .style-nav button.active {
            background: #66a;
            border-color: #88c;
        }
        .style-nav .arrow {
            font-size: 24px;
            padding: 5px 15px;
        }

        .style-name {
            text-align: center;
            font-size: 24px;
            color: #aaf;
            margin-bottom: 15px;
        }

        .canvas-wrapper {
            background: #111;
            padding: 40px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }
        canvas {
            image-rendering: pixelated;
            cursor: pointer;
        }

        .controls {
            flex: 0 0 320px;
            background: #2a2a4e;
            border-radius: 8px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #3a3a5e;
        }
        .control-group:last-child { border-bottom: none; }
        .control-group h3 {
            margin: 0 0 10px 0;
            color: #8af;
            font-size: 14px;
        }

        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .control-row label {
            flex: 0 0 100px;
            font-size: 12px;
            color: #aaa;
        }
        .control-row input[type="range"] {
            flex: 1;
            margin-right: 10px;
        }
        .control-row input[type="color"] {
            width: 40px;
            height: 25px;
            border: none;
            cursor: pointer;
        }
        .control-row input[type="text"] {
            flex: 1;
            background: #1a1a2e;
            border: 1px solid #446;
            color: #fff;
            padding: 5px 8px;
            border-radius: 4px;
        }
        .control-row .value {
            width: 40px;
            text-align: right;
            font-size: 12px;
            color: #888;
        }

        textarea {
            width: 100%;
            height: 80px;
            background: #1a1a2e;
            border: 1px solid #446;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-row button {
            flex: 1;
            background: #448;
            color: #fff;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        .btn-row button:hover { background: #66a; }

        .hint {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        /* Dialog pages */
        .dialog-page {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: #2a2a4e;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .dialog-page:hover { background: #3a3a5e; }
        .dialog-page.active { border-color: #4af; background: #3a3a6e; }
        .dialog-page .page-num {
            background: #446;
            color: #fff;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 10px;
        }
        .dialog-page .page-preview {
            font-size: 11px;
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }
    </style>
</head>
<body>
    <h1>Retro Dialog Editor</h1>
    <p class="subtitle">Click dialog to advance text ‚Ä¢ Use arrow keys or buttons to switch styles</p>

    <div class="container">
        <div class="preview-area">
            <div class="style-nav">
                <button class="arrow" onclick="prevStyle()">‚óÄ</button>
                <button onclick="setStyle(1)" id="btn1">1</button>
                <button onclick="setStyle(2)" id="btn2">2</button>
                <button onclick="setStyle(3)" id="btn3">3</button>
                <button onclick="setStyle(4)" id="btn4">4</button>
                <button onclick="setStyle(5)" id="btn5">5</button>
                <button onclick="setStyle(6)" id="btn6">6</button>
                <button class="arrow" onclick="nextStyle()">‚ñ∂</button>
            </div>
            <div class="style-name" id="styleName">Classic NES</div>
            <div class="canvas-wrapper">
                <canvas id="canvas" width="400" height="150"></canvas>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>üìù Text</h3>
                <div class="control-row">
                    <label>Speaker:</label>
                    <input type="text" id="speaker" value="Old Man" oninput="updatePreview()">
                </div>
                <textarea id="dialogText" oninput="updatePreview()">Hello traveler! Welcome to our village. The elder wishes to speak with you...</textarea>
                <div class="control-row" style="margin-top:10px">
                    <label>Text Speed:</label>
                    <input type="range" id="textSpeed" min="10" max="100" value="30" oninput="updateSpeed()">
                    <span class="value" id="speedVal">30ms</span>
                </div>
            </div>

            <div class="control-group">
                <h3>üìê Size & Position</h3>
                <div class="control-row">
                    <label>Width:</label>
                    <input type="range" id="boxWidth" min="200" max="500" value="400" oninput="updateSize()">
                    <span class="value" id="widthVal">400</span>
                </div>
                <div class="control-row">
                    <label>Height:</label>
                    <input type="range" id="boxHeight" min="80" max="200" value="150" oninput="updateSize()">
                    <span class="value" id="heightVal">150</span>
                </div>
                <div class="control-row">
                    <label>Scale:</label>
                    <input type="range" id="boxScale" min="1" max="3" step="0.5" value="1" oninput="updateSize()">
                    <span class="value" id="scaleVal">1x</span>
                </div>
            </div>

            <div class="control-group">
                <h3>üé® Colors</h3>
                <div class="control-row">
                    <label>Background:</label>
                    <input type="color" id="bgColor" value="#000033" oninput="updatePreview()">
                </div>
                <div class="control-row">
                    <label>Border:</label>
                    <input type="color" id="borderColor" value="#ffffff" oninput="updatePreview()">
                </div>
                <div class="control-row">
                    <label>Text:</label>
                    <input type="color" id="textColor" value="#ffffff" oninput="updatePreview()">
                </div>
                <div class="control-row">
                    <label>Accent:</label>
                    <input type="color" id="accentColor" value="#88aaff" oninput="updatePreview()">
                </div>
            </div>

            <div class="control-group">
                <h3>‚ú® Style Options</h3>
                <div class="control-row">
                    <label>Border Width:</label>
                    <input type="range" id="borderWidth" min="1" max="6" value="2" oninput="updatePreview()">
                    <span class="value" id="borderVal">2px</span>
                </div>
                <div class="control-row">
                    <label>Corner Radius:</label>
                    <input type="range" id="cornerRadius" min="0" max="20" value="0" oninput="updatePreview()">
                    <span class="value" id="radiusVal">0</span>
                </div>
                <div class="control-row">
                    <label>Padding:</label>
                    <input type="range" id="padding" min="8" max="30" value="16" oninput="updatePreview()">
                    <span class="value" id="paddingVal">16</span>
                </div>
                <div class="control-row">
                    <label>Font Size:</label>
                    <input type="range" id="fontSize" min="12" max="24" value="16" oninput="updatePreview()">
                    <span class="value" id="fontVal">16px</span>
                </div>
            </div>

            <div class="control-group">
                <h3>üìÑ Dialog Pages</h3>
                <div id="dialogPagesList" style="max-height:120px; overflow-y:auto; background:#1a1a2e; border-radius:4px; padding:8px; margin-bottom:10px;">
                    <div class="dialog-page active" data-index="0" onclick="selectDialogPage(0)">
                        <span class="page-num">1</span>
                        <span class="page-preview">Hello traveler!...</span>
                    </div>
                </div>
                <div class="btn-row">
                    <button onclick="addDialogPage()" style="background:#484;">+ Add Page</button>
                    <button onclick="removeDialogPage()" style="background:#844;">- Remove</button>
                </div>
            </div>

            <div class="btn-row">
                <button onclick="resetDialog()">‚Üª Reset Text</button>
                <button onclick="exportSettings()">üìã Copy Config</button>
            </div>
            <div class="btn-row" style="margin-top:5px;">
                <button onclick="getFullDialogConfig()" style="background:#486;">üì¶ Get Full Config</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        const styleNames = [
            'Classic NES',
            'Final Fantasy',
            'Pokemon',
            'Earthbound',
            'Chrono Trigger',
            'Modern Pixel'
        ];

        // Preset defaults for each style
        const stylePresets = {
            1: { bg: '#000000', border: '#ffffff', text: '#ffffff', accent: '#ffffff', radius: 0, borderW: 2 },
            2: { bg: '#000066', border: '#ffffff', text: '#ffffff', accent: '#8888ff', radius: 0, borderW: 3 },
            3: { bg: '#f8f8f8', border: '#303030', text: '#303030', accent: '#303030', radius: 8, borderW: 4 },
            4: { bg: '#000000', border: '#ff00ff', text: '#ffffff', accent: '#ffff00', radius: 0, borderW: 2 },
            5: { bg: '#101040', border: '#c0a040', text: '#ffffff', accent: '#c0a040', radius: 0, borderW: 3 },
            6: { bg: '#2a2a3a', border: '#4a4a6a', text: '#e0e0e0', accent: '#6a8aff', radius: 4, borderW: 2 }
        };

        let currentStyle = 1;
        let dialog = {
            text: document.getElementById('dialogText').value,
            speaker: document.getElementById('speaker').value,
            charIndex: 0,
            lastCharTime: 0,
            charDelay: 30,
            done: false
        };

        let settings = {
            width: 400,
            height: 150,
            scale: 1
        };

        // Multi-page dialog support
        let dialogPages = [
            { speaker: 'Old Man', text: 'Hello traveler! Welcome to our village. The elder wishes to speak with you...' }
        ];
        let currentPageIndex = 0;

        // Dialog page management
        function addDialogPage() {
            dialogPages.push({ speaker: dialog.speaker, text: 'New dialog text...' });
            updateDialogPagesList();
            selectDialogPage(dialogPages.length - 1);
        }

        function removeDialogPage() {
            if (dialogPages.length <= 1) return;
            dialogPages.splice(currentPageIndex, 1);
            if (currentPageIndex >= dialogPages.length) currentPageIndex = dialogPages.length - 1;
            updateDialogPagesList();
            selectDialogPage(currentPageIndex);
        }

        function selectDialogPage(index) {
            // Save current page before switching
            dialogPages[currentPageIndex] = {
                speaker: document.getElementById('speaker').value,
                text: document.getElementById('dialogText').value
            };
            currentPageIndex = index;
            // Load selected page
            const page = dialogPages[index];
            document.getElementById('speaker').value = page.speaker;
            document.getElementById('dialogText').value = page.text;
            dialog.speaker = page.speaker;
            dialog.text = page.text;
            resetDialog();
            updateDialogPagesList();
        }

        function updateDialogPagesList() {
            const list = document.getElementById('dialogPagesList');
            list.innerHTML = dialogPages.map((page, i) => {
                const preview = page.text.substring(0, 25) + (page.text.length > 25 ? '...' : '');
                const activeClass = i === currentPageIndex ? 'active' : '';
                return `<div class="dialog-page ${activeClass}" data-index="${i}" onclick="selectDialogPage(${i})">
                    <span class="page-num">${i + 1}</span>
                    <span class="page-preview">${preview}</span>
                </div>`;
            }).join('');
        }

        // Get full dialog config for saving with triggers
        function getFullDialogConfig() {
            // Save current page first
            dialogPages[currentPageIndex] = {
                speaker: document.getElementById('speaker').value,
                text: document.getElementById('dialogText').value
            };

            const config = {
                style: currentStyle,
                styleName: styleNames[currentStyle - 1],
                width: settings.width,
                height: settings.height,
                scale: settings.scale,
                colors: {
                    background: document.getElementById('bgColor').value,
                    border: document.getElementById('borderColor').value,
                    text: document.getElementById('textColor').value,
                    accent: document.getElementById('accentColor').value
                },
                borderWidth: parseInt(document.getElementById('borderWidth').value),
                cornerRadius: parseInt(document.getElementById('cornerRadius').value),
                padding: parseInt(document.getElementById('padding').value),
                fontSize: parseInt(document.getElementById('fontSize').value),
                textSpeed: dialog.charDelay,
                pages: dialogPages
            };

            console.log('Dialog Config:', config);
            navigator.clipboard.writeText(JSON.stringify(config, null, 2));
            alert('Full dialog config copied to clipboard!');
            return config;
        }

        // Load a full dialog config (for editing existing dialogs)
        function setFullDialogConfig(config) {
            if (!config) return;

            // Set style
            if (config.style) setStyle(config.style);

            // Set size
            if (config.width) {
                document.getElementById('boxWidth').value = config.width;
                settings.width = config.width;
            }
            if (config.height) {
                document.getElementById('boxHeight').value = config.height;
                settings.height = config.height;
            }
            if (config.scale) {
                document.getElementById('boxScale').value = config.scale;
                settings.scale = config.scale;
            }
            updateSize();

            // Set colors
            if (config.colors) {
                if (config.colors.background) document.getElementById('bgColor').value = config.colors.background;
                if (config.colors.border) document.getElementById('borderColor').value = config.colors.border;
                if (config.colors.text) document.getElementById('textColor').value = config.colors.text;
                if (config.colors.accent) document.getElementById('accentColor').value = config.colors.accent;
            }

            // Set style options
            if (config.borderWidth) document.getElementById('borderWidth').value = config.borderWidth;
            if (config.cornerRadius) document.getElementById('cornerRadius').value = config.cornerRadius;
            if (config.padding) document.getElementById('padding').value = config.padding;
            if (config.fontSize) document.getElementById('fontSize').value = config.fontSize;
            if (config.textSpeed) {
                document.getElementById('textSpeed').value = config.textSpeed;
                dialog.charDelay = config.textSpeed;
            }

            // Set pages
            if (config.pages && config.pages.length > 0) {
                dialogPages = config.pages;
                currentPageIndex = 0;
                const firstPage = dialogPages[0];
                document.getElementById('speaker').value = firstPage.speaker;
                document.getElementById('dialogText').value = firstPage.text;
                dialog.speaker = firstPage.speaker;
                dialog.text = firstPage.text;
                updateDialogPagesList();
            }

            updatePreview();
            resetDialog();
        }

        function setStyle(num) {
            currentStyle = num;
            document.getElementById('styleName').textContent = styleNames[num - 1];

            // Update nav buttons
            for (let i = 1; i <= 6; i++) {
                document.getElementById('btn' + i).classList.toggle('active', i === num);
            }

            // Apply preset colors
            const preset = stylePresets[num];
            document.getElementById('bgColor').value = preset.bg;
            document.getElementById('borderColor').value = preset.border;
            document.getElementById('textColor').value = preset.text;
            document.getElementById('accentColor').value = preset.accent;
            document.getElementById('cornerRadius').value = preset.radius;
            document.getElementById('borderWidth').value = preset.borderW;
            document.getElementById('radiusVal').textContent = preset.radius;
            document.getElementById('borderVal').textContent = preset.borderW + 'px';

            resetDialog();
        }

        function prevStyle() {
            setStyle(currentStyle === 1 ? 6 : currentStyle - 1);
        }

        function nextStyle() {
            setStyle(currentStyle === 6 ? 1 : currentStyle + 1);
        }

        function resetDialog() {
            dialog.text = document.getElementById('dialogText').value;
            dialog.speaker = document.getElementById('speaker').value;
            dialog.charIndex = 0;
            dialog.done = false;
            dialog.lastCharTime = 0;
        }

        function updatePreview() {
            dialog.text = document.getElementById('dialogText').value;
            dialog.speaker = document.getElementById('speaker').value;
            document.getElementById('borderVal').textContent = document.getElementById('borderWidth').value + 'px';
            document.getElementById('radiusVal').textContent = document.getElementById('cornerRadius').value;
            document.getElementById('paddingVal').textContent = document.getElementById('padding').value;
            document.getElementById('fontVal').textContent = document.getElementById('fontSize').value + 'px';
        }

        function updateSpeed() {
            dialog.charDelay = parseInt(document.getElementById('textSpeed').value);
            document.getElementById('speedVal').textContent = dialog.charDelay + 'ms';
        }

        function updateSize() {
            settings.width = parseInt(document.getElementById('boxWidth').value);
            settings.height = parseInt(document.getElementById('boxHeight').value);
            settings.scale = parseFloat(document.getElementById('boxScale').value);

            canvas.width = settings.width;
            canvas.height = settings.height;
            canvas.style.transform = `scale(${settings.scale})`;

            document.getElementById('widthVal').textContent = settings.width;
            document.getElementById('heightVal').textContent = settings.height;
            document.getElementById('scaleVal').textContent = settings.scale + 'x';
        }

        function exportSettings() {
            const config = {
                style: currentStyle,
                styleName: styleNames[currentStyle - 1],
                width: settings.width,
                height: settings.height,
                scale: settings.scale,
                colors: {
                    background: document.getElementById('bgColor').value,
                    border: document.getElementById('borderColor').value,
                    text: document.getElementById('textColor').value,
                    accent: document.getElementById('accentColor').value
                },
                borderWidth: parseInt(document.getElementById('borderWidth').value),
                cornerRadius: parseInt(document.getElementById('cornerRadius').value),
                padding: parseInt(document.getElementById('padding').value),
                fontSize: parseInt(document.getElementById('fontSize').value),
                textSpeed: dialog.charDelay
            };
            navigator.clipboard.writeText(JSON.stringify(config, null, 2));
            alert('Config copied to clipboard!');
        }

        // Get current settings
        function getSettings() {
            return {
                bgColor: document.getElementById('bgColor').value,
                borderColor: document.getElementById('borderColor').value,
                textColor: document.getElementById('textColor').value,
                accentColor: document.getElementById('accentColor').value,
                borderWidth: parseInt(document.getElementById('borderWidth').value),
                cornerRadius: parseInt(document.getElementById('cornerRadius').value),
                padding: parseInt(document.getElementById('padding').value),
                fontSize: parseInt(document.getElementById('fontSize').value)
            };
        }

        // Draw functions for each style
        function drawDialog() {
            const w = canvas.width;
            const h = canvas.height;
            const s = getSettings();
            const displayText = dialog.text.substring(0, dialog.charIndex);

            ctx.clearRect(0, 0, w, h);

            switch(currentStyle) {
                case 1: drawNES(w, h, s, displayText); break;
                case 2: drawFF(w, h, s, displayText); break;
                case 3: drawPokemon(w, h, s, displayText); break;
                case 4: drawEarthbound(w, h, s, displayText); break;
                case 5: drawChrono(w, h, s, displayText); break;
                case 6: drawModern(w, h, s, displayText); break;
            }
        }

        function drawNES(w, h, s, text) {
            // Background
            ctx.fillStyle = s.bgColor;
            roundRect(ctx, 4, 4, w - 8, h - 8, s.cornerRadius);
            ctx.fill();

            // Double border
            ctx.strokeStyle = s.borderColor;
            ctx.lineWidth = s.borderWidth;
            roundRect(ctx, 6, 6, w - 12, h - 12, s.cornerRadius);
            ctx.stroke();
            roundRect(ctx, 10, 10, w - 20, h - 20, Math.max(0, s.cornerRadius - 4));
            ctx.stroke();

            // Text
            ctx.fillStyle = s.textColor;
            ctx.font = s.fontSize + 'px Arial';
            wrapText(ctx, text, s.padding + 8, s.padding + 8, w - s.padding * 2 - 16, s.fontSize + 4);

            // Arrow
            if (dialog.done && Math.floor(Date.now() / 300) % 2 === 0) {
                ctx.fillStyle = s.accentColor;
                ctx.fillText('‚ñº', w - 24, h - 20);
            }
        }

        function drawFF(w, h, s, text) {
            // Gradient background
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, s.bgColor);
            grad.addColorStop(1, adjustColor(s.bgColor, -30));
            ctx.fillStyle = grad;
            roundRect(ctx, 4, 4, w - 8, h - 8, s.cornerRadius);
            ctx.fill();

            // Border
            ctx.strokeStyle = s.borderColor;
            ctx.lineWidth = s.borderWidth;
            roundRect(ctx, 4, 4, w - 8, h - 8, s.cornerRadius);
            ctx.stroke();

            // Corner decorations
            ctx.fillStyle = s.accentColor;
            ctx.fillRect(2, 2, 10, 10);
            ctx.fillRect(w - 12, 2, 10, 10);
            ctx.fillRect(2, h - 12, 10, 10);
            ctx.fillRect(w - 12, h - 12, 10, 10);

            // Speaker name box
            ctx.fillStyle = s.bgColor;
            ctx.fillRect(16, -2, 90, 22);
            ctx.strokeStyle = s.borderColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(16, -2, 90, 22);
            ctx.fillStyle = s.accentColor;
            ctx.font = 'bold 12px Arial';
            ctx.fillText(dialog.speaker, 22, 13);

            // Text
            ctx.fillStyle = s.textColor;
            ctx.font = s.fontSize + 'px Arial';
            wrapText(ctx, text, s.padding, 28, w - s.padding * 2, s.fontSize + 4);

            // Arrow
            if (dialog.done) {
                const bounce = Math.sin(Date.now() / 150) * 3;
                ctx.fillStyle = s.accentColor;
                ctx.fillText('‚ñ∂', w - 24, h - 20 + bounce);
            }
        }

        function drawPokemon(w, h, s, text) {
            // White background
            ctx.fillStyle = s.bgColor;
            roundRect(ctx, 4, 4, w - 8, h - 8, s.cornerRadius);
            ctx.fill();

            // Thick border
            ctx.strokeStyle = s.borderColor;
            ctx.lineWidth = s.borderWidth;
            roundRect(ctx, 4, 4, w - 8, h - 8, s.cornerRadius);
            ctx.stroke();

            // Inner shadow
            ctx.strokeStyle = adjustColor(s.borderColor, 60);
            ctx.lineWidth = 2;
            roundRect(ctx, 8, 8, w - 16, h - 16, Math.max(0, s.cornerRadius - 2));
            ctx.stroke();

            // Text
            ctx.fillStyle = s.textColor;
            ctx.font = 'bold ' + s.fontSize + 'px Arial';
            wrapText(ctx, text, s.padding, s.padding, w - s.padding * 2, s.fontSize + 6);

            // Dot indicator
            if (dialog.done && Math.floor(Date.now() / 400) % 2 === 0) {
                ctx.beginPath();
                ctx.arc(w - 20, h - 20, 6, 0, Math.PI * 2);
                ctx.fillStyle = s.accentColor;
                ctx.fill();
            }
        }

        function drawEarthbound(w, h, s, text) {
            // Outer colored box
            ctx.fillStyle = s.accentColor;
            ctx.fillRect(0, 0, w, h);

            // Black inner
            ctx.fillStyle = s.bgColor;
            ctx.fillRect(6, 6, w - 12, h - 12);

            // Rainbow border
            const colors = ['#ff0000', '#ff8800', '#ffff00', '#00ff00', '#00ffff', '#0088ff', '#ff00ff'];
            for (let i = 0; i < 6; i++) {
                ctx.strokeStyle = colors[i];
                ctx.lineWidth = 1;
                ctx.strokeRect(6 - i, 6 - i, w - 12 + i * 2, h - 12 + i * 2);
            }

            // Inner white border
            ctx.strokeStyle = s.borderColor;
            ctx.lineWidth = s.borderWidth;
            ctx.strokeRect(10, 10, w - 20, h - 20);

            // Text
            ctx.fillStyle = s.textColor;
            ctx.font = s.fontSize + 'px Arial';
            wrapText(ctx, text, s.padding, s.padding, w - s.padding * 2, s.fontSize + 4);

            // Spinning star
            if (dialog.done) {
                ctx.save();
                ctx.translate(w - 20, h - 20);
                ctx.rotate(Date.now() / 200);
                ctx.fillStyle = '#ff0';
                ctx.font = '16px Arial';
                ctx.fillText('‚òÖ', -8, 6);
                ctx.restore();
            }
        }

        function drawChrono(w, h, s, text) {
            // Dark background
            ctx.fillStyle = s.bgColor;
            roundRect(ctx, 4, 4, w - 8, h - 8, s.cornerRadius);
            ctx.fill();

            // Gold border
            ctx.strokeStyle = s.accentColor;
            ctx.lineWidth = s.borderWidth;
            roundRect(ctx, 4, 4, w - 8, h - 8, s.cornerRadius);
            ctx.stroke();

            // Inner decorative line
            ctx.strokeStyle = adjustColor(s.accentColor, -40);
            ctx.lineWidth = 1;
            roundRect(ctx, 8, 8, w - 16, h - 16, Math.max(0, s.cornerRadius - 2));
            ctx.stroke();

            // Corner flourishes
            ctx.fillStyle = s.accentColor;
            ctx.fillRect(2, 2, 14, 3);
            ctx.fillRect(2, 2, 3, 14);
            ctx.fillRect(w - 16, 2, 14, 3);
            ctx.fillRect(w - 5, 2, 3, 14);
            ctx.fillRect(2, h - 5, 14, 3);
            ctx.fillRect(2, h - 16, 3, 14);
            ctx.fillRect(w - 16, h - 5, 14, 3);
            ctx.fillRect(w - 5, h - 16, 3, 14);

            // Speaker name
            ctx.fillStyle = s.accentColor;
            ctx.font = 'bold 12px Arial';
            ctx.fillText(dialog.speaker + ':', s.padding, 22);

            // Text
            ctx.fillStyle = s.textColor;
            ctx.font = s.fontSize + 'px Arial';
            wrapText(ctx, text, s.padding, 36, w - s.padding * 2, s.fontSize + 4);

            // Diamond
            if (dialog.done) {
                const pulse = 0.5 + Math.sin(Date.now() / 200) * 0.5;
                ctx.globalAlpha = pulse;
                ctx.fillStyle = s.accentColor;
                ctx.font = '14px Arial';
                ctx.fillText('‚óÜ', w - 22, h - 16);
                ctx.globalAlpha = 1;
            }
        }

        function drawModern(w, h, s, text) {
            // Gradient background
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, s.bgColor);
            grad.addColorStop(1, adjustColor(s.bgColor, -20));
            ctx.fillStyle = grad;
            roundRect(ctx, 4, 4, w - 8, h - 8, s.cornerRadius);
            ctx.fill();

            // Border
            ctx.strokeStyle = s.borderColor;
            ctx.lineWidth = s.borderWidth;
            roundRect(ctx, 4, 4, w - 8, h - 8, s.cornerRadius);
            ctx.stroke();

            // Top accent line
            ctx.fillStyle = s.accentColor;
            ctx.fillRect(8, 4, w - 16, 3);

            // Portrait placeholder
            ctx.fillStyle = adjustColor(s.bgColor, 20);
            ctx.fillRect(s.padding, 20, 44, 44);
            ctx.strokeStyle = s.borderColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(s.padding, 20, 44, 44);
            ctx.fillStyle = s.borderColor;
            ctx.font = '28px Arial';
            ctx.fillText('üë§', s.padding + 8, 54);

            // Speaker name
            ctx.fillStyle = s.accentColor;
            ctx.font = 'bold 12px Arial';
            ctx.fillText(dialog.speaker, s.padding + 52, 30);

            // Text
            ctx.fillStyle = s.textColor;
            ctx.font = s.fontSize + 'px Arial';
            wrapText(ctx, text, s.padding + 52, 44, w - s.padding - 60, s.fontSize + 4);

            // Arrow
            if (dialog.done) {
                const bounce = Math.sin(Date.now() / 200) * 2;
                ctx.fillStyle = s.accentColor;
                ctx.fillText('‚ñº', w - 22, h - 16 + bounce);
            }
        }

        // Helpers
        function roundRect(ctx, x, y, w, h, r) {
            if (r === 0) {
                ctx.beginPath();
                ctx.rect(x, y, w, h);
                return;
            }
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let currentY = y;

            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && i > 0) {
                    ctx.fillText(line, x, currentY);
                    line = words[i] + ' ';
                    currentY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, currentY);
        }

        function adjustColor(hex, amount) {
            const num = parseInt(hex.slice(1), 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // Animation loop
        function animate() {
            const now = Date.now();

            if (!dialog.done && dialog.charIndex < dialog.text.length) {
                if (now - dialog.lastCharTime > dialog.charDelay) {
                    dialog.charIndex++;
                    dialog.lastCharTime = now;
                    if (dialog.charIndex >= dialog.text.length) {
                        dialog.done = true;
                    }
                }
            }

            drawDialog();
            requestAnimationFrame(animate);
        }

        // Events
        canvas.addEventListener('click', () => {
            if (dialog.charIndex < dialog.text.length) {
                dialog.charIndex = dialog.text.length;
                dialog.done = true;
            } else {
                resetDialog();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevStyle();
            if (e.key === 'ArrowRight') nextStyle();
            if (e.key >= '1' && e.key <= '6') setStyle(parseInt(e.key));
            if (e.key === ' ') {
                e.preventDefault();
                if (dialog.charIndex < dialog.text.length) {
                    dialog.charIndex = dialog.text.length;
                    dialog.done = true;
                } else {
                    resetDialog();
                }
            }
        });

        // Init
        setStyle(1);
        animate();
    </script>
</body>
</html>
